---
const menuItems = [
  {
    text: "Accueil",
    url: "/",
    icon: "üè†"
  },
  {
    text: "Cours",
    url: "/cours",
    icon: "üéì",
    submenu: [
      {
        text: "Guitare",
        url: "/cours/cours-de-guitare",
        icon: "üé∏",
        description: "Apprenez la guitare de A √† Z"
      },
      {
        text: "Piano",
        url: "/cours/cours-de-piano",
        icon: "üéπ",
        description: "Ma√Ætrisez le piano facilement"
      },
      {
        text: "Ukul√©l√©",
        url: "/cours/cours-de-ukulele",
        icon: "üèñÔ∏è",
        description: "D√©butez avec le ukul√©l√©"
      },
      {
        text: "Solf√®ge",
        url: "/cours/cours-de-solfege",
        icon: "üéº",
        description: "Comprenez la th√©orie musicale"
      }
    ]
  },
  {
    text: "Blog",
    url: "/blog",
    icon: "üìù"
  },
  {
    text: "√Ä propos",
    url: "/a-propos",
    icon: "üëã"
  },
  {
    text: "Podcast",
    url: "https://podcast.ausha.co/au-boulot-maestro-le-podcast-qui-t-apprend-a-apprendre-la-musique",
    icon: "üéôÔ∏è",
    external: true
  }
];
---

<header class="header" id="header">
  <div class="header-container">
    <nav class="nav">
      <!-- Logo avec animation -->
      <a href="/" class="logo">
        <span class="logo-icon">üéµ</span>
        <span class="logo-text">Musique Facile</span>
      </a>

      <!-- Menu Desktop -->
      <ul class="nav-menu desktop-menu">
        {menuItems.map(item => (
          <li class="nav-item">
            {item.submenu ? (
              <div class="nav-dropdown">
                <a
                  href={item.url}
                  class="nav-link has-submenu"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span class="nav-icon">{item.icon}</span>
                  <span class="nav-text">{item.text}</span>
                  <svg class="dropdown-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </a>
                <div class="mega-menu">
                  <div class="mega-menu-content">
                    <a href={item.url} class="mega-menu-item mega-menu-all">
                      <span class="mega-icon">üìö</span>
                      <div class="mega-text">
                        <span class="mega-title">Tous les cours</span>
                        <span class="mega-desc">Voir l'ensemble de nos formations</span>
                      </div>
                    </a>
                    {item.submenu.map(subitem => (
                      <a href={subitem.url} class="mega-menu-item">
                        <span class="mega-icon">{subitem.icon}</span>
                        <div class="mega-text">
                          <span class="mega-title">{subitem.text}</span>
                          <span class="mega-desc">{subitem.description}</span>
                        </div>
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            ) : (
              <a
                href={item.url}
                class="nav-link"
                {...item.external ? { target: "_blank", rel: "noopener noreferrer" } : {}}
              >
                <span class="nav-icon">{item.icon}</span>
                <span class="nav-text">{item.text}</span>
                {item.external && (
                  <svg class="external-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                    <path d="M10 1L1 10M10 1H4M10 1V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                )}
              </a>
            )}
          </li>
        ))}
      </ul>

      <!-- Dark Mode Toggle -->
      <button class="theme-toggle" id="theme-toggle" aria-label="Basculer le th√®me sombre">
        <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>

      <!-- CTA Button -->
      <a href="https://ecole.musique-facile.fr/login" class="cta-button" target="_blank" rel="noopener noreferrer">
        <span class="cta-icon">üîê</span>
        <span class="cta-text">Connexion</span>
      </a>

      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" aria-label="Menu mobile" aria-expanded="false">
        <span class="hamburger">
          <span class="line"></span>
          <span class="line"></span>
          <span class="line"></span>
        </span>
      </button>
    </nav>
  </div>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-overlay">
    <div class="mobile-menu">
      <ul class="mobile-nav">
        {menuItems.map(item => (
          <li class="mobile-item">
            {item.submenu ? (
              <div class="mobile-dropdown">
                <button class="mobile-link has-submenu">
                  <span class="mobile-icon">{item.icon}</span>
                  <span class="mobile-text">{item.text}</span>
                  <svg class="mobile-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <ul class="mobile-submenu">
                  {item.submenu.map(subitem => (
                    <li>
                      <a href={subitem.url} class="mobile-sublink">
                        <span class="mobile-subicon">{subitem.icon}</span>
                        <span>{subitem.text}</span>
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ) : (
              <a
                href={item.url}
                class="mobile-link"
                {...item.external ? { target: "_blank", rel: "noopener noreferrer" } : {}}
              >
                <span class="mobile-icon">{item.icon}</span>
                <span class="mobile-text">{item.text}</span>
              </a>
            )}
          </li>
        ))}
        <li class="mobile-item mobile-cta">
          <a href="https://ecole.musique-facile.fr/login" class="mobile-cta-btn" target="_blank" rel="noopener noreferrer">
            <span class="mobile-icon">üîê</span>
            <span class="mobile-text">Connexion</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</header>

<style>
  /* ========================================
     HEADER BASE
     ======================================== */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: linear-gradient(135deg,
      rgba(0, 194, 142, 0.95) 0%,
      rgba(0, 174, 131, 0.95) 100%
    );
    backdrop-filter: blur(20px) saturate(180%);
    box-shadow: 0 4px 30px rgba(0, 194, 142, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .header.scrolled {
    background: rgba(0, 194, 142, 0.98);
    box-shadow: 0 8px 32px rgba(0, 194, 142, 0.2);
  }

  .header-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
  }

  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 80px;
    position: relative;
  }

  /* ========================================
     LOGO
     ======================================== */
  .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: white;
    font-weight: 700;
    font-size: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1001;
  }

  .logo-icon {
    font-size: 2rem;
    animation: float 3s ease-in-out infinite;
  }

  .logo:hover .logo-icon {
    animation: spin 0.6s ease;
  }

  .logo-text {
    background: linear-gradient(135deg, #fff 0%, #e0f7f3 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* ========================================
     DESKTOP MENU
     ======================================== */
  .desktop-menu {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-item {
    position: relative;
  }

  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    background: transparent;
    border: none;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
  }

  .nav-link::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .nav-link:hover::before,
  .nav-link:focus::before {
    opacity: 1;
  }

  .nav-link:hover {
    transform: translateY(-2px);
  }

  .nav-icon {
    font-size: 1.25rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }

  .dropdown-icon,
  .external-icon {
    opacity: 0.7;
    transition: all 0.3s ease;
  }

  .nav-link:hover .dropdown-icon,
  .nav-link:hover .external-icon {
    opacity: 1;
  }

  .nav-dropdown.active .dropdown-icon {
    transform: rotate(180deg);
  }

  /* ========================================
     MEGA MENU
     ======================================== */
  .mega-menu {
    position: absolute;
    top: calc(100% + 1rem);
    left: 50%;
    transform: translateX(-50%) scale(0.95);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
  }

  .nav-dropdown.active .mega-menu {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) scale(1);
    pointer-events: auto;
  }

  .mega-menu-content {
    background: white;
    border-radius: 20px;
    padding: 1rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    min-width: 450px;
  }

  .mega-menu-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    text-decoration: none;
    color: var(--gray-800);
    transition: all 0.3s ease;
    background: transparent;
  }

  .mega-menu-item:hover {
    background: var(--brand-50);
    transform: translateX(5px);
  }

  .mega-icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .mega-text {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mega-title {
    font-weight: 600;
    font-size: 1rem;
    color: var(--gray-900);
  }

  .mega-desc {
    font-size: 0.85rem;
    color: var(--gray-600);
    line-height: 1.4;
  }

  /* ========================================
     CTA BUTTON
     ======================================== */
  .cta-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: var(--brand-600);
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .cta-button::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--brand-500), var(--brand-600));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .cta-button:hover::before {
    opacity: 1;
  }

  .cta-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0, 194, 142, 0.3);
    color: white;
  }

  .cta-icon,
  .cta-text {
    position: relative;
    z-index: 1;
  }

  /* ========================================
     THEME TOGGLE
     ======================================== */
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
  }

  .theme-toggle .icon-sun,
  .theme-toggle .icon-moon {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* Light mode: show sun, hide moon */
  .theme-toggle .icon-sun {
    display: block;
  }
  .theme-toggle .icon-moon {
    display: none;
  }

  /* Dark mode: show moon, hide sun */
  [data-theme="dark"] .theme-toggle .icon-sun {
    display: none;
  }
  [data-theme="dark"] .theme-toggle .icon-moon {
    display: block;
  }

  @media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) .theme-toggle .icon-sun {
      display: none;
    }
    :root:not([data-theme="light"]) .theme-toggle .icon-moon {
      display: block;
    }
  }

  /* ========================================
     MOBILE MENU BUTTON
     ======================================== */
  .mobile-menu-btn {
    display: none;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .mobile-menu-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .hamburger {
    display: flex;
    flex-direction: column;
    gap: 5px;
    width: 24px;
  }

  .line {
    width: 100%;
    height: 2px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .mobile-menu-btn.active .line:nth-child(1) {
    transform: rotate(45deg) translateY(7px);
  }

  .mobile-menu-btn.active .line:nth-child(2) {
    opacity: 0;
    transform: translateX(-10px);
  }

  .mobile-menu-btn.active .line:nth-child(3) {
    transform: rotate(-45deg) translateY(-7px);
  }

  /* ========================================
     MOBILE OVERLAY
     ======================================== */
  .mobile-overlay {
    position: fixed;
    inset: 0;
    top: 80px;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 999;
  }

  .mobile-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .mobile-menu {
    position: absolute;
    top: 0;
    right: 0;
    width: min(400px, 85vw);
    height: 100%;
    background: linear-gradient(180deg,
      rgba(0, 194, 142, 0.98) 0%,
      rgba(0, 160, 119, 0.98) 100%
    );
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    padding: 2rem 1.5rem;
  }

  .mobile-overlay.active .mobile-menu {
    transform: translateX(0);
  }

  .mobile-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .mobile-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 500;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
  }

  .mobile-link:hover,
  .mobile-link:focus {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
  }

  .mobile-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .mobile-text {
    flex: 1;
  }

  .mobile-arrow {
    opacity: 0.7;
    transition: transform 0.3s ease;
  }

  .mobile-dropdown.active .mobile-arrow {
    transform: rotate(180deg);
  }

  .mobile-submenu {
    display: none;
    list-style: none;
    margin: 0.5rem 0 0 0;
    padding: 0;
    padding-left: 1rem;
  }

  .mobile-dropdown.active .mobile-submenu {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mobile-sublink {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .mobile-sublink:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .mobile-subicon {
    font-size: 1.25rem;
  }

  .mobile-cta-btn {
    margin-top: 1rem;
    background: white;
    color: var(--brand-600);
    font-weight: 600;
    justify-content: center;
  }

  .mobile-cta-btn:hover {
    background: rgba(255, 255, 255, 0.95);
    transform: translateY(-2px);
  }

  /* ========================================
     RESPONSIVE
     ======================================== */
  @media (max-width: 1024px) {
    .desktop-menu {
      gap: 0.25rem;
    }

    .nav-link {
      padding: 0.65rem 1rem;
      font-size: 0.9rem;
    }

    .mega-menu-content {
      min-width: 400px;
    }
  }

  @media (max-width: 768px) {
    .nav {
      height: 70px;
    }

    .desktop-menu,
    .cta-button {
      display: none;
    }

    .mobile-menu-btn {
      display: flex;
    }

    .mobile-overlay {
      top: 70px;
    }

    .logo-text {
      font-size: 1.25rem;
    }

    .logo-icon {
      font-size: 1.75rem;
    }
  }

  @media (max-width: 480px) {
    .header-container {
      padding: 0 1rem;
    }

    .logo-text {
      font-size: 1.1rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.getElementById('header');
    const mobileBtn = document.querySelector('.mobile-menu-btn');
    const mobileOverlay = document.querySelector('.mobile-overlay');
    const dropdowns = document.querySelectorAll('.nav-dropdown');
    const mobileDropdowns = document.querySelectorAll('.mobile-dropdown');

    // Scroll effect
    let lastScroll = 0;
    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;

      if (currentScroll > 50) {
        header?.classList.add('scrolled');
      } else {
        header?.classList.remove('scrolled');
      }

      lastScroll = currentScroll;
    });

    // Mobile menu toggle
    mobileBtn?.addEventListener('click', () => {
      mobileBtn.classList.toggle('active');
      mobileOverlay?.classList.toggle('active');
      document.body.style.overflow = mobileOverlay?.classList.contains('active') ? 'hidden' : '';
    });

    // Close mobile menu on overlay click
    mobileOverlay?.addEventListener('click', (e) => {
      if (e.target === mobileOverlay) {
        mobileBtn?.classList.remove('active');
        mobileOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // Desktop dropdowns - hover + click/touch support
    dropdowns.forEach(dropdown => {
      let timeout: ReturnType<typeof setTimeout>;
      const btn = dropdown.querySelector('.has-submenu');

      // Hover (desktop only)
      if (window.matchMedia('(hover: hover)').matches) {
        dropdown.addEventListener('mouseenter', () => {
          clearTimeout(timeout);
          dropdown.classList.add('active');
        });

        dropdown.addEventListener('mouseleave', () => {
          timeout = setTimeout(() => {
            dropdown.classList.remove('active');
          }, 150);
        });
      }

      // Click/Touch - only toggle dropdown, don't prevent navigation
      btn?.addEventListener('click', (e) => {
        // On touch devices, toggle dropdown on first click
        if (!window.matchMedia('(hover: hover)').matches) {
          const isActive = dropdown.classList.contains('active');
          if (!isActive) {
            e.preventDefault();
            dropdowns.forEach(d => d.classList.remove('active'));
            dropdown.classList.add('active');
          }
          // If already active, let the link navigate
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest('.nav-dropdown')) {
        dropdowns.forEach(d => d.classList.remove('active'));
      }
    });

    // Mobile dropdowns - click
    mobileDropdowns.forEach(dropdown => {
      const btn = dropdown.querySelector('.has-submenu');
      btn?.addEventListener('click', (e) => {
        e.preventDefault();
        dropdown.classList.toggle('active');
      });
    });

    // Close mobile menu on link click
    const mobileLinks = document.querySelectorAll('.mobile-sublink, .mobile-link:not(.has-submenu)');
    mobileLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileBtn?.classList.remove('active');
        mobileOverlay?.classList.remove('active');
        document.body.style.overflow = '';
      });
    });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const root = document.documentElement;

    // Get saved theme or detect system preference
    const getSavedTheme = () => localStorage.getItem('theme');
    const getSystemTheme = () => window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';

    // Apply theme
    const applyTheme = (theme: string) => {
      if (theme === 'dark') {
        root.setAttribute('data-theme', 'dark');
      } else if (theme === 'light') {
        root.setAttribute('data-theme', 'light');
      } else {
        root.removeAttribute('data-theme'); // Use system preference
      }
    };

    // Initialize theme
    const savedTheme = getSavedTheme();
    if (savedTheme) {
      applyTheme(savedTheme);
    }

    // Toggle theme on click
    themeToggle?.addEventListener('click', () => {
      const currentTheme = root.getAttribute('data-theme');
      const systemTheme = getSystemTheme();

      let newTheme: string;
      if (!currentTheme) {
        // No explicit theme set, using system. Toggle to opposite.
        newTheme = systemTheme === 'dark' ? 'light' : 'dark';
      } else {
        // Explicit theme set. Toggle it.
        newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      }

      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (!getSavedTheme()) {
        // Only react if user hasn't set explicit preference
        applyTheme(e.matches ? 'dark' : 'light');
      }
    });
  });
</script>
