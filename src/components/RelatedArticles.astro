---
import { getCollection } from 'astro:content';

/**
 * Composant Articles Connexes Intelligents v2.0
 * Recommande des articles bas√©s sur :
 * - Tags communs (50%)
 * - M√™me instrument (30%)
 * - Niveau similaire (20%)
 */

interface Props {
  currentSlug: string;
  currentTags?: string[];
  currentInstrument?: string;
  currentLevel?: string;
  maxArticles?: number;
}

const {
  currentSlug,
  currentTags = [],
  currentInstrument = '',
  currentLevel = 'tous-niveaux',
  maxArticles = 3
} = Astro.props;

// R√©cup√©rer tous les articles publi√©s
const allPosts = await getCollection('blog');
const currentDate = new Date();

const publishedPosts = allPosts.filter(post =>
  post.slug !== currentSlug &&
  post.data.prod !== 'N' &&
  new Date(post.data.datePublished) <= currentDate &&
  !post.data.prev // Exclure pages multiples
);

// Fonction de calcul de score de similarit√©
function calculateSimilarity(post: any): number {
  let score = 0;

  // 1. Tags communs (50 points max)
  if (currentTags.length > 0 && post.data.tags && post.data.tags.length > 0) {
    const commonTags = currentTags.filter(tag =>
      post.data.tags.includes(tag)
    );
    score += (commonTags.length / currentTags.length) * 50;
  }

  // 2. M√™me instrument (30 points max)
  const postInstrument = post.data.instrument || detectInstrument(post);
  if (currentInstrument && postInstrument === currentInstrument) {
    score += 30;
  }

  // 3. Niveau similaire (20 points max)
  const postLevel = post.data.level || 'tous-niveaux';
  if (currentLevel === postLevel || postLevel === 'tous-niveaux') {
    score += 20;
  }

  return score;
}

// Fonction pour d√©tecter l'instrument depuis le contenu (fallback)
function detectInstrument(post: any): string {
  const content = `${post.data.title} ${post.data.description || ''}`.toLowerCase();
  if (content.includes('guitare')) return 'guitare';
  if (content.includes('piano')) return 'piano';
  if (content.includes('ukulele') || content.includes('ukul√©l√©')) return 'ukulele';
  if (content.includes('solfege') || content.includes('solf√®ge')) return 'solfege';
  return 'g√©n√©ral';
}

// Calculer les scores et trier
const scoredPosts = publishedPosts
  .map(post => ({
    post,
    score: calculateSimilarity(post)
  }))
  .sort((a, b) => b.score - a.score)
  .slice(0, maxArticles);

// Fallback : si pas assez d'articles avec score > 0, prendre les plus r√©cents
const relatedArticles = scoredPosts.length >= maxArticles
  ? scoredPosts.map(sp => sp.post)
  : [
      ...scoredPosts.map(sp => sp.post),
      ...publishedPosts
        .filter(p => !scoredPosts.find(sp => sp.post.slug === p.slug))
        .sort((a, b) => new Date(b.data.datePublished).getTime() - new Date(a.data.datePublished).getTime())
        .slice(0, maxArticles - scoredPosts.length)
    ];
---

{relatedArticles.length > 0 && (
  <section class="related-articles">
    <div class="container">
      <h2 class="related-title">Articles qui pourraient vous int√©resser</h2>
      <div class="related-grid">
        {relatedArticles.map(post => {
          const instrument = post.data.instrument || detectInstrument(post);
          return (
            <a href={`/blog/${post.slug}`} class="related-card">
              <div class="card-image" style={`background-image: url(${post.data.ogImage})`}>
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="card-tags">
                    {post.data.tags.slice(0, 2).map((tag: string) => (
                      <span class="tag">{tag}</span>
                    ))}
                  </div>
                )}
                <div class="card-overlay">
                  <span class="read-more">Lire l'article ‚Üí</span>
                </div>
              </div>
              <div class="card-content">
                <div class="card-meta">
                  <span class="card-instrument" data-instrument={instrument}>
                    {instrument === 'guitare' && 'üé∏'}
                    {instrument === 'piano' && 'üéπ'}
                    {instrument === 'ukulele' && 'üèñÔ∏è'}
                    {instrument === 'solfege' && 'üéº'}
                    {instrument === 'g√©n√©ral' && 'üéµ'}
                    {instrument.charAt(0).toUpperCase() + instrument.slice(1)}
                  </span>
                  {post.data.level && post.data.level !== 'tous-niveaux' && (
                    <span class="card-level">{post.data.level}</span>
                  )}
                </div>
                <h3 class="card-title">{post.data.title}</h3>
                <p class="card-description">{post.data.description.slice(0, 120)}...</p>
              </div>
            </a>
          );
        })}
      </div>
    </div>
  </section>
)}

<style>
  .related-articles {
    padding: 4rem 0;
    background: var(--bg-light);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .related-title {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 3rem;
    color: var(--theme-current);
    font-weight: var(--font-bold);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
  }

  .related-card {
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .related-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .card-image {
    height: 200px;
    background-size: cover;
    background-position: center;
    position: relative;
  }

  .card-tags {
    position: absolute;
    top: 1rem;
    left: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    z-index: 2;
  }

  .tag {
    background: rgba(255, 255, 255, 0.95);
    padding: 0.3rem 0.8rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-dark);
    backdrop-filter: blur(10px);
  }

  .card-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .related-card:hover .card-overlay {
    opacity: 1;
  }

  .read-more {
    color: white;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border: 2px solid white;
    border-radius: var(--border-radius);
  }

  .card-content {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .card-meta {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
  }

  .card-instrument,
  .card-level {
    font-size: 0.8rem;
    padding: 0.3rem 0.8rem;
    border-radius: 50px;
    font-weight: 600;
  }

  .card-instrument {
    background: var(--theme-current);
    color: white;
  }

  .card-level {
    background: var(--bg-light);
    color: var(--color-dark);
    border: 1px solid var(--gray-300);
  }

  .card-title {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: var(--color-dark);
    line-height: 1.4;
    font-weight: var(--font-bold);
  }

  .card-description {
    font-size: 0.9rem;
    color: var(--gray-600);
    opacity: 0.8;
    margin: 0;
    line-height: 1.6;
    flex: 1;
  }

  @media (max-width: 1024px) {
    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .related-articles {
      padding: 3rem 0;
    }

    .related-title {
      font-size: 1.8rem;
      margin-bottom: 2rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .card-image {
      height: 180px;
    }

    .card-content {
      padding: 1.25rem;
    }
  }
</style>
