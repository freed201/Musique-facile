---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import SearchBar from '../../components/blog/SearchBar.astro';
import FilterBar from '../../components/blog/FilterBar.astro';
import ArticleCard from '../../components/blog/ArticleCard.astro';
import Pagination from '../../components/blog/Pagination.astro';
import { getCollection } from 'astro:content';

// R√©cup√©rer TOUS les articles (pas de limite √† 50)
const allPosts = await getCollection('blog');
const currentDate = new Date();

// Filtrer les articles publi√©s
const publishedPosts = allPosts
  .filter(post => {
    if (post.data.prod !== 'Y') return false;
    const publishDate = new Date(post.data.datePublished);
    if (publishDate > currentDate) return false;
    if (post.data.prev) return false;
    return true;
  })
  .sort((a, b) => new Date(b.data.datePublished).getTime() - new Date(a.data.datePublished).getTime());

// Fonction pour d√©tecter l'instrument
function detectInstrument(post: any): string {
  const content = `${post.data.title} ${post.data.description || ''}`.toLowerCase();
  if (content.includes('guitare')) return 'guitare';
  if (content.includes('piano')) return 'piano';
  if (content.includes('ukulele') || content.includes('ukul√©l√©')) return 'ukulele';
  if (content.includes('solfege') || content.includes('solf√®ge')) return 'solfege';
  return 'general';
}

// Compter les articles par instrument
const instrumentCounts = {
  total: publishedPosts.length,
  guitare: publishedPosts.filter(p => detectInstrument(p) === 'guitare').length,
  piano: publishedPosts.filter(p => detectInstrument(p) === 'piano').length,
  ukulele: publishedPosts.filter(p => detectInstrument(p) === 'ukulele').length,
  solfege: publishedPosts.filter(p => detectInstrument(p) === 'solfege').length,
};

// M√©tadonn√©es
const canonicalURL = new URL(Astro.url.pathname, Astro.site || 'https://musique-facile.fr').toString();
const title = "Blog Musical | Guitare, Piano, Ukul√©l√© ‚Äî Musique Facile";
const description = "D√©couvre tous nos articles pour progresser en musique : techniques, artistes, morceaux, conseils d'apprentissage, astuces de pratique‚Ä¶ Un concentr√© d'inspiration pour musiciens passionn√©s, d√©butants ou curieux.";
const ogImage = "/images/og-blog.jpg";

// Schema.org Blog
const blogSchema = {
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": "Blog Musique Facile",
  "description": "Articles, conseils et astuces pour progresser en musique",
  "url": canonicalURL,
  "blogPost": publishedPosts.slice(0, 20).map(post => ({
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "image": post.data.ogImage,
    "datePublished": post.data.datePublished,
    "dateModified": post.data.dateModified,
    "author": {
      "@type": "Person",
      "name": post.data.author
    },
    "url": `${Astro.url.origin}/blog/${post.slug}`
  }))
};

// Schema.org ItemList pour am√©liorer le r√©f√©rencement du listing
const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Articles du Blog Musique Facile",
  "description": "Liste compl√®te des articles pour apprendre la musique",
  "numberOfItems": publishedPosts.length,
  "itemListElement": publishedPosts.map((post, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `${Astro.url.origin}/blog/${post.slug}`,
    "name": post.data.title,
    "description": post.data.description
  }))
};

const ARTICLES_PER_PAGE = 12;
const totalPages = Math.ceil(publishedPosts.length / ARTICLES_PER_PAGE);
---

<Layout
  title={title}
  description={description}
  ogImage={ogImage}
  canonicalUrl={canonicalURL}
  keywords="blog musique en ligne, articles sur l'apprentissage musical, blog guitare piano ukul√©l√©, conseils pour musiciens d√©butants, actualit√© musicale et p√©dagogie"
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(blogSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  </Fragment>

  <Header />

  <main>
    <!-- Hero Section -->
    <section class="blog-hero">
      <div class="hero-background"></div>
      <div class="hero-overlay"></div>
      <div class="container">
        <h1>Blog Musique Facile</h1>
        <p class="subtitle">
          D√©couvre {publishedPosts.length} articles pour progresser en musique : techniques, artistes, morceaux, conseils d'apprentissage, astuces de pratique‚Ä¶ Un concentr√© d'inspiration pour musiciens passionn√©s, d√©butants ou curieux.
        </p>
      </div>
    </section>

    <!-- Contenu Principal -->
    <section class="blog-content">
      <div class="container">
        <!-- Barre de Recherche -->
        <SearchBar />

        <!-- Filtres -->
        <FilterBar counts={instrumentCounts} />

        <!-- Statistiques -->
        <div class="blog-stats" id="blogStats">
          <span id="statsText">Affichage de {publishedPosts.length} articles</span>
        </div>

        <!-- Grille d'articles -->
        <div class="blog-grid" id="blogGrid">
          {publishedPosts.map((post) => (
            <ArticleCard
              slug={post.slug}
              title={post.data.title}
              description={post.data.description || ''}
              image={post.data.ogImage}
              author={post.data.author}
              datePublished={post.data.datePublished}
              instrument={detectInstrument(post)}
            />
          ))}
        </div>

        <!-- √âtat vide (cach√© par d√©faut) -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <div class="empty-icon">üîç</div>
          <h2>Aucun article trouv√©</h2>
          <p>Essayez de modifier vos filtres ou votre recherche</p>
          <button class="btn-reset" id="resetFilters">R√©initialiser les filtres</button>
        </div>

        <!-- Pagination -->
        <Pagination totalPages={totalPages} articlesPerPage={ARTICLES_PER_PAGE} />

        <!-- Section About -->
        <div class="blog-about">
          <h2>Notre blog musical</h2>
          <div class="blog-about-content">
            <p>Le blog Musique Facile est un espace pens√© pour t'accompagner dans ton parcours musical, quel que soit ton niveau ou ton instrument. Tu y trouveras des articles pour apprendre la guitare, le piano ou l'ukul√©l√©, mais aussi des r√©flexions sur l'apprentissage, des portraits d'artistes, des m√©thodes pour mieux t'entra√Æner et progresser. Que tu sois autodidacte, √©l√®ve, parent ou simple amateur, chaque article t'apporte des id√©es concr√®tes, motivantes et faciles √† mettre en pratique. La musique est une aventure : ce blog est l√† pour t'inspirer √† chaque √©tape.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* Hero */
  .blog-hero {
    padding: 8rem 0 4rem;
    background: linear-gradient(135deg, var(--color-dark) 0%, #2a2a2a 100%);
    color: white;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .hero-background {
    position: absolute;
    inset: 0;
    background-image: url('/images/blog/hero.webp');
    background-size: cover;
    background-position: center;
    opacity: 0.3;
    z-index: 0;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
    z-index: 1;
  }

  .blog-hero .container {
    position: relative;
    z-index: 2;
  }

  .blog-hero h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    color: white;
    animation: fadeIn 0.6s ease-in-out;
  }

  .subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.9);
    max-width: 900px;
    margin: 0 auto 2rem;
    line-height: 1.6;
    animation: fadeIn 0.6s ease-in-out 0.2s forwards;
    opacity: 0;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Content */
  .blog-content {
    padding: 4rem 0;
    background: var(--bg-page);
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Stats */
  .blog-stats {
    text-align: center;
    margin-bottom: 3rem;
    font-size: 1.1rem;
    color: var(--text-secondary);
    font-weight: 600;
  }

  /* Grille */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-bottom: 4rem;
    min-height: 400px;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .empty-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.5;
  }

  .empty-state h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }

  .empty-state p {
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-bottom: 2rem;
  }

  .btn-reset {
    padding: 1rem 2rem;
    background: var(--theme-current);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-reset:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 194, 142, 0.3);
  }

  /* About */
  .blog-about {
    background: var(--bg-card);
    border-radius: var(--border-radius);
    padding: 3rem;
    margin-top: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .blog-about h2 {
    color: var(--theme-current);
    font-size: 2rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .blog-about-content p {
    color: var(--text-secondary);
    line-height: 1.8;
    font-size: 1.1rem;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .blog-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .blog-hero h1 {
      font-size: 2.5rem;
    }

    .subtitle {
      font-size: 1rem;
    }

    .blog-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .blog-about {
      padding: 2rem;
    }
  }
</style>

<script define:vars={{ ARTICLES_PER_PAGE }}>
  document.addEventListener('DOMContentLoaded', () => {
    // R√©cup√©rer tous les articles
    const allArticles = Array.from(document.querySelectorAll('.article-card'));
    let filteredArticles = [...allArticles];
    let currentFilter = 'all';
    let currentSearchTerm = '';
    let currentPage = 1;

    const blogGrid = document.getElementById('blogGrid');
    const emptyState = document.getElementById('emptyState');
    const statsText = document.getElementById('statsText');

    // Fonction pour afficher/masquer les articles selon la pagination
    function paginateArticles() {
      const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
      const endIndex = startIndex + ARTICLES_PER_PAGE;

      // D'abord, masquer TOUS les articles
      allArticles.forEach(article => {
        article.style.display = 'none';
      });

      // Ensuite, afficher seulement les articles filtr√©s pour la page courante
      filteredArticles.forEach((article, index) => {
        if (index >= startIndex && index < endIndex) {
          article.style.display = '';
          article.style.animation = `cardFadeIn 0.5s ease ${(index - startIndex) * 0.05}s forwards`;
        }
      });

      // Dispatcher event pour mettre √† jour la pagination
      document.dispatchEvent(new CustomEvent('articlesFiltered', {
        detail: {
          count: filteredArticles.length,
          total: allArticles.length,
          currentPage: currentPage
        }
      }));
    }

    // Fonction de recherche
    function searchArticles(searchTerm) {
      currentSearchTerm = searchTerm;
      applyFilters();
    }

    // Fonction de filtrage
    function filterByInstrument(filter) {
      currentFilter = filter;
      applyFilters();
    }

    // Appliquer tous les filtres
    function applyFilters() {
      filteredArticles = allArticles.filter(article => {
        // Filtre par instrument
        if (currentFilter !== 'all') {
          const instrument = article.dataset.instrument;
          if (instrument !== currentFilter) return false;
        }

        // Filtre par recherche
        if (currentSearchTerm) {
          const title = article.querySelector('.card-title')?.textContent.toLowerCase() || '';
          const description = article.querySelector('.card-description')?.textContent.toLowerCase() || '';
          const searchLower = currentSearchTerm.toLowerCase();

          if (!title.includes(searchLower) && !description.includes(searchLower)) {
            return false;
          }
        }

        return true;
      });

      // R√©initialiser √† la page 1
      currentPage = 1;

      // Afficher/masquer empty state
      if (filteredArticles.length === 0) {
        blogGrid.style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        blogGrid.style.display = 'grid';
        emptyState.style.display = 'none';
        paginateArticles();
      }

      // Mettre √† jour les stats
      updateStats();

      // Dispatcher r√©sultats de recherche
      document.dispatchEvent(new CustomEvent('searchResults', {
        detail: { count: filteredArticles.length }
      }));
    }

    // Mettre √† jour les statistiques
    function updateStats() {
      if (currentSearchTerm || currentFilter !== 'all') {
        statsText.textContent = `${filteredArticles.length} article(s) trouv√©(s)`;
      } else {
        statsText.textContent = `Affichage de ${allArticles.length} articles`;
      }
    }

    // √âcouter les √©v√©nements
    document.addEventListener('blogSearch', (e) => {
      searchArticles(e.detail.searchTerm);
    });

    document.addEventListener('blogFilter', (e) => {
      filterByInstrument(e.detail.filter);
    });

    document.addEventListener('pageChange', (e) => {
      console.log('üì• Blog received pageChange event:', e.detail.page);
      currentPage = e.detail.page;
      paginateArticles();
    });

    // Bouton reset
    const resetBtn = document.getElementById('resetFilters');
    resetBtn?.addEventListener('click', () => {
      currentFilter = 'all';
      currentSearchTerm = '';
      currentPage = 1;

      // Reset search input
      const searchInput = document.getElementById('blogSearch');
      if (searchInput) searchInput.value = '';

      // Reset filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('[data-filter="all"]')?.classList.add('active');

      applyFilters();
    });

    // Initialisation
    paginateArticles();
  });
</script>
