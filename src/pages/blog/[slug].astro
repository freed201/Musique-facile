---
import { getCollection } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import FAQSchema from '../../components/FAQSchema.astro';
import RelatedArticles from '../../components/RelatedArticles.astro';
import BreadcrumbsSchema from '../../components/BreadcrumbsSchema.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  // Filtrer les articles par date et prod status
  const currentDate = new Date();
  return blogEntries
    .filter(entry => {
      // Ne pas g√©n√©rer si l'article a prod="N"
      if (entry.data.prod !== 'Y') return false;
      
      // Ne pas g√©n√©rer si la date de publication est dans le futur
      const publishDate = new Date(entry.data.datePublished);
      if (publishDate > currentDate) return false;
      
      // Sinon, g√©n√©rer la page
      return true;
    })
    .map(entry => ({
      params: { slug: entry.slug },
      props: { entry },
    }));
}

// Fonction utilitaire pour extraire l'ID YouTube d'une URL et g√©rer les shorts
function getYouTubeEmbedUrl(url: string) {
  // Gestion des shorts YouTube
  if (url.includes('/shorts/')) {
    const shortId = url.split('/shorts/')[1].split('?')[0];
    return `https://www.youtube.com/embed/${shortId}?si=QQvDZ8APhQNzMK1R`;
  }
  
  // Gestion des URLs YouTube standard
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  const videoId = (match && match[2].length === 11) ? match[2] : null;
  
  return videoId ? `https://www.youtube.com/embed/${videoId}?si=QQvDZ8APhQNzMK1R` : null;
}

const { entry } = Astro.props;
const {
  title,
  description,
  ogImage,
  author,
  datePublished,
  dateModified,
  theme,
  schemaType = 'BlogPosting',
  introduction,
  songInfo,
  videos,
  podcast,
  conclusion,
  relatedLinks,
  faqs
} = entry.data;

const { Content, headings } = await entry.render();

// D√©terminer si l'article est "long" (5+ headings H2/H3)
const showTOC = headings.filter(h => h.depth === 2 || h.depth === 3).length >= 5;

// Calcul du temps de lecture (estimation bas√©e sur le contenu)
const wordCount = entry.body.split(/\s+/).length; // Nombre de mots
const readingTime = Math.ceil(wordCount / 250); // 250 mots/minute en moyenne

// Construction de l'URL compl√®te pour schema.org
const canonicalURL = new URL(Astro.url.pathname, 'https://musique-facile.fr');

// Construction du schema.org
const schema = {
  "@context": "https://schema.org",
  "@type": schemaType,
  "headline": title,
  "description": description,
  "image": ogImage,
  "author": {
    "@type": "Person",
    "name": author
  },
}

// Construction des breadcrumbs dynamiques
const breadcrumbItems = [
  { name: "Accueil", url: "/" },
  { name: "Blog", url: "/blog" }
];

// Ajouter un niveau interm√©diaire si l'article a un instrument sp√©cifique
if (entry.data.instrument && entry.data.instrument !== 'g√©n√©ral') {
  const instrumentMap: Record<string, { name: string; url: string }> = {
    'guitare': { name: 'Guitare', url: '/blog/guitare' },
    'piano': { name: 'Piano', url: '/blog/piano' },
    'ukulele': { name: 'Ukul√©l√©', url: '/blog/ukulele' },
    'solfege': { name: 'Solf√®ge', url: '/blog/solfege' }
  };

  const instrumentData = instrumentMap[entry.data.instrument];
  if (instrumentData) {
    breadcrumbItems.push(instrumentData);
  }
}
---

<ArticleLayout
  title={title}
  description={description}
  ogImage={ogImage}
  author={author}
  datePublished={datePublished}
  dateModified={dateModified}
  url={canonicalURL.toString()}
  theme={theme}
  videos={videos}
  songInfo={songInfo}
  showAutoFaq={!(faqs && faqs.length > 0)}
>
  <article>
    <!-- Breadcrumbs -->
    <BreadcrumbsSchema
      items={breadcrumbItems}
      currentPage={title}
    />

    <section class="article-hero">
      <div class="article-hero-bg" style={`background-image: url(${ogImage})`}></div>
      <div class="article-hero-content">
        <div class="article-meta">
          {entry.data.number && (
            <span class="article-number" title={`Page ${entry.data.number}`}>
              {entry.data.number}
            </span>
          )}
          <time datetime={datePublished}>
            {new Date(datePublished).toLocaleDateString('fr-FR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          <span class="article-author">Par {author}</span>
          <span class="reading-time" title={`Environ ${readingTime} minute${readingTime > 1 ? 's' : ''} de lecture`}>
            üìñ {readingTime} min
          </span>
        </div>
        <h1 class="article-title">{title}</h1>
        <p class="article-description">{description}</p>
      </div>
    </section>

    <!-- Navigation entre les pages (en haut) -->
    {entry.data.multi === 'Y' && (
      <nav class="article-navigation top-nav">
        {entry.data.prev && (
          <a href={`/blog/${entry.data.prev}`} class="nav-link prev">
            <span class="nav-arrow">‚Üê</span>
            <span class="nav-text">Page pr√©c√©dente</span>
          </a>
        )}
        {entry.data.next && (
          <a href={`/blog/${entry.data.next}`} class="nav-link next">
            <span class="nav-text">Page suivante</span>
            <span class="nav-arrow">‚Üí</span>
          </a>
        )}
      </nav>
    )}

  {songInfo && songInfo.inBook && (
  <div class="song-info">
    <div class="song-info-content">
      <div class="song-info-book">
        <img
          src="/images/livres/CARMF2838.jpg"
          alt="40 chansons fran√ßaises et hits pop-rock - Livre de guitare avec tablatures et partitions"
          width="720"
          height="1024"
          loading="lazy"
          decoding="async"
        />
        <div class="book-details">
          {songInfo.bookPage && (
            <p class="book-message">Plonge directement dans ce morceau avec tous les conseils et la tablature compl√®te √† la page {songInfo.bookPage} de mon livre ! üé∏</p>
          )}
          <a href="https://c3po.link/QJCFDcrJfE" class="book-link" target="_blank" rel="noopener noreferrer">
            D√©couvre le livre maintenant !
          </a>
        </div>
      </div>
      <div class="song-details">
        {songInfo.tempo && (
          <div class="song-detail">
            <span class="detail-icon">üéµ</span>
            <span class="detail-label">Tempo</span>
            <span class="detail-value">{songInfo.tempo} BPM</span>
          </div>
        )}
        {songInfo.chordCount && (
          <div class="song-detail">
            <span class="detail-icon">üé∏</span>
            <span class="detail-label">Accords</span>
            <span class="detail-value">{songInfo.chordCount}</span>
          </div>
        )}
        {songInfo.key && (
          <div class="song-detail">
            <span class="detail-icon">üéπ</span>
            <span class="detail-label">Tonalit√©</span>
            <span class="detail-value">{songInfo.key}</span>
          </div>
        )}
        {songInfo.difficulty && (
          <div class="song-detail">
            <span class="detail-icon">üìä</span>
            <span class="detail-label">Difficult√©</span>
            <span class="detail-value">{songInfo.difficulty}</span>
          </div>
        )}
      </div>
    </div>
  </div>
)}

    <div class={`article-content ${showTOC ? 'with-toc' : ''}`}>
      {showTOC && (
        <TableOfContents headings={headings} />
      )}

      <div class="article-main">
        <!-- Introduction -->
        <div class="article-intro">
          {introduction}
        </div>

<!-- Vid√©os (si pr√©sentes) -->
{videos && videos.length > 0 && (
  <section class="video-section">
    <div class="video-grid">
      {videos.map(video => {
        const embedUrl = getYouTubeEmbedUrl(video.url);
        return embedUrl && (
          <div class="video-item">
            <div class="video-wrapper">
              <iframe
                width="560"
                height="315"
                src={embedUrl}
                title={video.title}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        );
      })}
    </div>
  </section>
      )}

      <!-- Podcast (si pr√©sent) -->
      {podcast && (
        <section class="podcast-section">
          <div class="podcast-player">
          <iframe name="Ausha Podcast Player" frameborder="0" loading="lazy" id="ausha-kz2n" height="500" style="border: none; width:100%; height:500px" src={podcast.url}"></iframe><script src="https://player.ausha.co/ausha-player.js"></script>
</div>
        </section>
      )}

      <!-- Contenu principal -->
      <div class="article-body">
        <Content />
      </div>

      <!-- Conclusion (seulement si pr√©sente et non vide) -->
      {conclusion && conclusion.trim() !== '' && (
        <section class="article-conclusion">
          <div class="conclusion-content">
            <h2>Conclusion</h2>
            <div set:html={conclusion}></div>
          </div>
        </section>
      )}

      <!-- Navigation entre les pages -->
      {entry.data.multi === 'Y' && (
        <nav class="article-navigation bottom-nav">
          {entry.data.prev && (
            <a href={`/blog/${entry.data.prev}`} class="nav-link prev">
              <span class="nav-arrow">‚Üê</span>
              <span class="nav-text">Page pr√©c√©dente</span>
            </a>
          )}
          {entry.data.next && (
            <a href={`/blog/${entry.data.next}`} class="nav-link next">
              <span class="nav-text">Page suivante</span>
              <span class="nav-arrow">‚Üí</span>
            </a>
          )}
        </nav>
      )}

      <section class="course-buttons">
        <div class="container">
          <h2 class="section-title">Alors, pr√™t(e) √† rejoindre l'aventure ?</h2>
          <div class="buttons-grid">
            <a href="/cours/cours-de-guitare" class="course-button theme-guitar">
              <div class="button-background" style="background-image: url('/images/cours/cours-de-guitare.webp')"></div>
              <div class="button-content">
                <span class="button-icon">üé∏</span>
                <div class="button-text-wrapper">
                  <span class="button-title">Cours de Guitare</span>
                  <span class="button-description">Apprenez la guitare pas √† pas</span>
                </div>
                <span class="button-arrow">‚Üí</span>
              </div>
            </a>

            <a href="/cours/cours-de-piano" class="course-button theme-piano">
              <div class="button-background" style="background-image: url('/images/cours/cours-de-piano.webp')"></div>
              <div class="button-content">
                <span class="button-icon">üéπ</span>
                <div class="button-text-wrapper">
                  <span class="button-title">Cours de Piano</span>
                  <span class="button-description">D√©couvrez le piano facilement</span>
                </div>
                <span class="button-arrow">‚Üí</span>
              </div>
            </a>

            <a href="/cours/cours-de-ukulele" class="course-button theme-ukulele">
              <div class="button-background" style="background-image: url('/images/cours/cours-de-ukulele.webp')"></div>
              <div class="button-content">
                <span class="button-icon">üèñÔ∏è</span>
                <div class="button-text-wrapper">
                  <span class="button-title">Cours d'Ukul√©l√©</span>
                  <span class="button-description">Initiez-vous √† l'ukul√©l√©</span>
                </div>
                <span class="button-arrow">‚Üí</span>
              </div>
            </a>

            <a href="/cours/cours-de-solfege" class="course-button theme-solfege">
              <div class="button-background" style="background-image: url('/images/cours/cours-de-solfege.webp')"></div>
              <div class="button-content">
                <span class="button-icon">üéº</span>
                <div class="button-text-wrapper">
                  <span class="button-title">Cours de Solf√®ge</span>
                  <span class="button-description">Ma√Ætrisez la th√©orie musicale</span>
                </div>
                <span class="button-arrow">‚Üí</span>
              </div>
            </a>
          </div>
        </div>
      </section>

      </div> <!-- Fin .article-main -->
    </div> <!-- Fin .article-content -->

    <!-- FAQ Section (si pr√©sente) - En pleine largeur -->
    {faqs && faqs.length > 0 && (
      <FAQSchema faqs={faqs} showVisual={true} />
    )}

    <!-- Section Articles Similaires (Intelligent) - En pleine largeur -->
    <RelatedArticles
      currentSlug={entry.slug}
      currentTags={entry.data.tags || []}
      currentInstrument={entry.data.instrument}
      currentLevel={entry.data.level}
      maxArticles={3}
    />
  </article>
</ArticleLayout>

<style>
  .article-number {
    background: var(--theme-current);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: help;
  }

  .reading-time {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: help;
  }

  .song-info {
    position: relative;
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  .song-info-content {
    background: var(--color-dark);
    border-radius: var(--border-radius);
    padding: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .song-info-book {
    display: flex;
    gap: 2rem;
    align-items: center;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .song-info-book img {
    width: 120px;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  }

  .book-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .book-message {
    color: white;
    font-size: 1.1rem;
    line-height: 1.5;
    margin: 0;
  }

  .book-link {
    display: inline-block;
    background: var(--theme-current);
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    align-self: flex-start;
  }

  .book-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  .song-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1.5rem;
  }

  .song-detail {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.3rem;
  }

  .detail-icon {
    font-size: 1.5rem;
  }

  .detail-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-value {
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
  }

  @media (max-width: 768px) {
    .song-info-book {
      flex-direction: column;
      text-align: center;
      gap: 1.5rem;
    }

    .book-details {
      align-items: center;
    }

    .book-link {
      align-self: center;
    }

    .song-details {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .course-buttons {
    padding: 4rem 0;
    background: var(--bg-light);
  }

  .course-buttons .section-title {
    text-align: center;
    font-size: 2.5rem;
    margin-bottom: 3rem;
    color: var(--theme-current);
    background: linear-gradient(135deg, var(--theme-current) 0%, var(--theme-current-light) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: fadeInUp 0.6s ease forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .buttons-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .course-button {
    position: relative;
    height: 200px;
    border-radius: var(--border-radius);
    overflow: hidden;
    text-decoration: none;
    color: white;
    transition: all 0.3s ease;
  }

  .button-background {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    transition: all 0.5s ease;
  }

  .button-content {
    position: relative;
    z-index: 1;
    height: 100%;
    padding: 1.5rem;
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.3),
      rgba(0, 0, 0, 0.8)
    );
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 1rem;
    transition: all 0.3s ease;
  }

  .button-icon {
    font-size: 2rem;
    background: rgba(255, 255, 255, 0.2);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-bottom: auto;
  }

  .button-text-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .button-title {
    font-size: 1.3rem;
    font-weight: 600;
  }

  .button-description {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .button-arrow {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
  }

  .course-button:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  }

  .course-button:hover .button-background {
    transform: scale(1.1);
  }

  .course-button:hover .button-content {
    background: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 0.5),
      rgba(0, 0, 0, 0.9)
    );
  }

  .course-button:hover .button-arrow {
    transform: translateX(5px);
  }

  @media (max-width: 1200px) {
    .buttons-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .buttons-grid {
      grid-template-columns: 1fr;
    }

    .course-button {
      height: 160px;
    }

    .button-icon {
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
    }

    .button-title {
      font-size: 1.2rem;
    }
  }

  /* Styles sp√©cifiques pour la navigation du haut */
  .article-navigation.top-nav {
    margin: 2rem auto;
    max-width: 800px;
    padding: 0 1.5rem;
  }

  /* Styles communs pour les deux navigations */
  .article-navigation {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
  }

  /* Styles sp√©cifiques pour la navigation du bas */
  .article-navigation.bottom-nav {
    margin: 4rem auto;
    max-width: 800px;
    padding: 0 1.5rem;
  }

  /* Layout de base - Pas de grille par d√©faut */
  .article-content {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Par d√©faut, article-main prend toute la largeur disponible */
  .article-main {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Layout TOC avec grille - SEULEMENT quand .with-toc est pr√©sent */
  .article-content.with-toc {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 3rem;
  }

  /* Dans la grille, article-main occupe la 2e colonne */
  .article-content.with-toc .article-main {
    min-width: 0; /* Fix pour grid overflow */
    max-width: none; /* Pas de limite dans la grille */
    margin: 0; /* Pas de centrage dans la grille */
  }

  @media (max-width: 1024px) {
    .article-content.with-toc {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }
</style>
